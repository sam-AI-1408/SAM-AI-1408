
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<title>{{ session.get('username', 'Player') }} ‚Äî Academics</title>

  <style>
    :root {
      --bg: #050615;
      --panel: #0f1630;
      --card: #0a1224;
      --accent: #00d0ff;
      --muted: #9fb2c4;
      --alert: #ff8fa3;
      --font-primary: 'Inter', "Segoe UI", Roboto, sans-serif;
      --radius-xl: 12px;
      --glass: rgba(255,255,255,0.03);
    }

    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      font-family: var(--font-primary);
      background: var(--bg);
      color: var(--accent);
      display: flex;
    }

    /* sidebar nav */
    .sidebar {
      width: 220px;
      background: var(--panel);
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 4px 0 20px rgba(0,0,0,0.5);
      gap: 12px;
    }
    .logo { font-size: 20px; font-weight: 700; text-align: center; color: var(--accent); }
    .nav { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .nav a { text-decoration:none; color:var(--accent); padding:8px; border-radius:10px; font-weight:600; }
    .nav a.active { background: linear-gradient(90deg, rgba(0,208,255,0.08), rgba(0,208,255,0.02)); box-shadow: inset 0 0 12px rgba(0,208,255,0.03); }
    .logout button {
      padding: 10px 12px; border: none; border-radius: 10px; background: var(--alert);
      color: #fff; cursor: pointer; font-weight: 600;
    }

    /* main column */
    .main {
      flex: 1;
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      min-height: 100vh;
    }

    .header-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    h1 { margin:0; color:var(--accent); font-size:22px; }
    .points-badge {
      background: var(--card);
      padding: 8px 12px;
      border-radius: 12px;
      font-weight:700;
      color: var(--accent);
    }

    /* form area */
    .board {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      align-items: start;
    }

    .left-card, .right-card {
      background: var(--panel);
      padding: 16px;
      border-radius: var(--radius-xl);
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
    }

    .left-card h3, .right-card h3 { margin-top:0; color:var(--accent); }

    .form-row { display:flex; gap:10px; align-items:center; margin-top:8px; }
    .form-row input, .form-row select, textarea {
      padding:10px; border-radius:10px; border:none; background:var(--card); color:var(--accent); outline:none; width:100%;
    }
    textarea { min-height:86px; resize:vertical; }

    .btn {
      padding:10px 12px; border-radius:10px; border:none; background:var(--accent); color:#001; cursor:pointer; font-weight:700;
    }

    /* completed sessions */
    .completed-list { margin-top:10px; max-height:380px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .session-item {
      display:flex; justify-content:space-between; gap:12px; align-items:center;
      background: var(--card); padding:12px; border-radius:10px; color:var(--muted);
    }
    .session-item .meta { font-size:13px; color:var(--muted); }

    /* popups / modals */
    .overlay {
      position: fixed; inset: 0; display: none; background: rgba(0,0,0,0.7); z-index:1200; justify-content:center; align-items:center;
    }
    .overlay.show { display:flex; }
    .modal {
      width: 420px; max-width: calc(100% - 40px);
      background: var(--panel); border-radius:12px; padding:18px; box-shadow: 0 0 40px rgba(0,0,0,0.7);
      border: 1px solid rgba(0,208,255,0.06);
    }
    .modal h4 { margin:0; color:var(--accent); }
    .modal .controls { margin-top:12px; display:flex; gap:10px; justify-content:center; }
    .modal input, .modal select, .modal textarea {
      width:100%; padding:10px; margin-top:10px; border-radius:8px; border:none; background:var(--card); color:var(--accent);
    }
    .timer-display {
      font-size:28px; text-align:center; margin-top:12px; color:var(--neon, var(--accent)); letter-spacing:1px;
    }
    .small { font-size:13px; color:var(--muted); }

    /* small responsive */
    @media (max-width:900px) {
      .board { grid-template-columns: 1fr; }
      .sidebar { display:none; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .xp-bar-container {
    margin-top: 12px;
    background: var(--card);
    border-radius: 12px;
    overflow: hidden;
    height: 18px;
  }
  .xp-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #00d0ff, #2ad19f);
    transition: width 0.5s ease;
  }
</style>

</head>
<body>
  <div class="sidebar">
    <div>
      <div class="logo">Sam AI</div>
      <nav class="nav">
        <a href="{{ url_for('profile') }}">Profile</a>
        <a href="{{ url_for('tasks_page') }}">Tasks</a>
        <a href="{{ url_for('academics') }}">Academics</a>
          <a href="{{ url_for('quests_page') }}">Quests</a>

          <a href="{{ url_for('developers') }}">Developers</a>

      </nav>
    </div>

    <div>
      <form action="{{ url_for('logout') }}" method="post">
        <button type="submit">Logout</button>
      </form>
    </div>
  </div>

  <div class="main">
    <div class="header-row">
      <h1>Academics ‚Äî Study Sessions</h1>
 <div class="points-badge">Points: <span id="points">{{ user.points or 0 }}</span></div>

    </div>

    <div class="board">
      <!-- left: Add & list -->
      <div class="left-card">
        <h3>Add session</h3>
        <p class="small">Click Add session to open the multi-step popup (hours ‚Üí date ‚Üí notes).</p>
        <div style="margin-top:12px;">
          <button class="btn" id="openAdd">‚ûï Add session</button>
        </div>

        <h3 style="margin-top:18px;">Completed sessions</h3>
        <div class="completed-list" id="completedList">
          <!-- completed sessions rendered here -->
        </div>
      </div>

      <!-- right: Quick past sessions / details -->
      <div class="right-card">
        <h3>Session preview & info</h3>
        <div class="small">When a session completes, confirm it and points will be awarded & stored.</div>
                  <div style="margin-top:12px;">
                     <a href="{{ url_for('shufflecard') }}"></a>
  <button class="btn" id="openShuffleCard">üé¥ Shuffle Cards</button>
</div>
<h3 style="margin-top:20px;">Progress</h3>
<div class="xp-bar-container">
  <div id="xpBar" class="xp-bar"></div>
</div>

<canvas id="studyChart" style="margin-top:16px;max-height:240px;"></canvas>

<h4 style="margin-top:12px;color:var(--accent);font-size:14px;">By Subject</h4>
<canvas id="subjectChart" style="margin-top:8px; max-height:220px;"></canvas>
        <div style="margin-top:12px;">
          <div class="small">Active scheduled sessions:</div>
          <ul id="scheduledOverview" style="margin:8px 0 0 0; padding:0; list-style:none;"></ul>
        </div>
      </div>
    </div>
  </div>
  

  <!-- AUDIO -->
  <audio id="alarmSound" src="{{ url_for('static', filename='alarm-301729.mp3') }}" preload="auto"></audio>

  <!-- MODALS -->
  
  <!-- Step 1: Duration (hours/minutes) -->
  <div class="overlay" id="stepDuration">
    <div class="modal">
      <h4>Step 1 ‚Äî Duration</h4>
      <div class="small">Enter how long the session will be.</div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <input id="inputHours" type="number" min="0" placeholder="Hours (0)" />
        <input id="inputMinutes" type="number" min="0" max="59" placeholder="Minutes (30)" />
      </div>
      <div class="controls" style="margin-top:12px;">
        <button class="btn cancel" id="durCancel">Cancel</button>
        <button class="btn" id="durNext">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Step 2: Start datetime -->
  <div class="overlay" id="stepSchedule">
    <div class="modal">
      <h4>Step 2 ‚Äî Schedule start</h4>
      <div class="small">Pick a date & time for the session to start (or leave as now).</div>
      <input id="inputStartAt" type="datetime-local" />
      <div class="controls">
        <button class="btn cancel" id="schBack">Back</button>
        <button class="btn" id="schNext">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Step 3: Notes -->
  <div class="overlay" id="stepNotes">
    <div class="modal">
      <h4>Step 3 ‚Äî What did you study?</h4>
      <div class="small">Write notes or topics you will cover (shown after completion).</div>
      <textarea id="inputNotes" placeholder="What will you study?"></textarea>
      <div class="controls">
        <button class="btn cancel" id="notesBack">Back</button>
        <button class="btn" id="startSession">Start Session</button>
      </div>
    </div>
  </div>
   <!-- Step 3: Notes (update to include Subject) -->
<div class="overlay" id="stepNotes">
  <div class="modal">
    <h4>Step 3 ‚Äî What did you study?</h4>
    <div class="small">Choose subject, then write notes or topics you will cover (shown after completion).</div>

    <!-- SUBJECT SELECT -->
    <label style="display:block;margin-top:10px;color:var(--muted);font-size:13px;">Subject</label>
    <select id="inputSubject" style="margin-top:6px;">
      <option value="General">General</option>
      <option value="Math">Math</option>
      <option value="Physics">Physics</option>
      <option value="Chemistry">Chemistry</option>
      <option value="CS">Computer Science</option>
      <option value="Language">Language</option>
      <option value="Fitness">Fitness</option>
      <option value="Other">Other</option>
    </select>

    <textarea id="inputNotes" placeholder="What will you study?"></textarea>
    <div class="controls">
      <button class="btn cancel" id="notesBack">Back</button>
      <button class="btn" id="startSession">Start Session</button>
    </div>
  </div>
</div>

  <!-- Timer Modal -->
  <div class="overlay" id="timerModal">
    <div class="modal">
      <h4>Session Timer</h4>
      <div class="small" id="timerSessionMeta"></div>
      <div class="timer-display" id="timerDisplay">00:00:00</div>
      <div class="controls" style="margin-top:12px;">
        <button class="btn cancel" id="cancelTimer">‚ùå Cancel</button>
      </div>
    </div>
  </div>

  <!-- Completion popup -->
  <div class="overlay" id="completionModal">
    <div class="modal">
      <h4>Session finished ‚Äî Completed?</h4>
      <div class="small" id="completionMeta"></div>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
        <button class="btn" id="markYes">‚úÖ Yes ‚Äî Save & Award Points</button>
        <button class="btn cancel" id="markNo">‚ùå No ‚Äî Discard</button>
      </div>
    </div>
  </div>
<audio id="clickSound" src="/static/click.mp3" preload="auto"></audio>

  <!-- Floating Voice Assistant Button -->
<!-- Floating Voice Button -->
<button id="micBtn" style="
  position: fixed; bottom: 20px; right: 20px; 
  width: 60px; height: 60px; border-radius: 50%;
  background: #00d0ff; color: #050615; font-size: 28px;
  border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
  üé§
</button>



<p id="voice-feedback" style="
    position: fixed;
    bottom: 90px;
    right: 20px;
    background: var(--panel);
    color: var(--accent);
    padding: 10px;
    border-radius: 10px;
    font-size: 14px;
    max-width: 200px;
"></p>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ================== GLOBAL STATE ================== */
const clickSound = document.getElementById("clickSound");
const alarmSound = document.getElementById("alarmSound");
let studyChart = null;      // weekly line/bar chart
let subjectChart = null;    // pie chart for subject distribution

const addBtn = document.getElementById("openAdd");
const pointsEl = document.getElementById("points");
const completedList = document.getElementById("completedList");
const scheduledOverview = document.getElementById("scheduledOverview");

let state = {
  hours: 0,
  minutes: 0,
  startAt: null,
  notes: "",
  subject: "General",
  timerInterval: null,
  countdownRemainingMs: 0,
  scheduledTimeoutId: null,
  activeSessionId: null
};

/* ================== SOUND & BUTTONS ================== */
document.querySelectorAll("button").forEach(btn => {
  btn.addEventListener("click", () => {
    if (clickSound) { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
  });
});
const shuffleBtn = document.getElementById("openShuffleCard");
if (shuffleBtn) shuffleBtn.onclick = () => { window.location.href = "/shufflecard"; };

/* ================== UI HELPERS ================== */
function showOverlay(id){ const el=document.getElementById(id); if(el) el.classList.add("show"); }
function hideOverlay(id){ const el=document.getElementById(id); if(el) el.classList.remove("show"); }

/* ================== OPEN FLOW ================== */
addBtn.addEventListener("click", () => {
  state.hours = 0; state.minutes = 30; state.startAt = null; state.notes = ""; state.subject = "General";
  document.getElementById("inputHours").value = "";
  document.getElementById("inputMinutes").value = "";
  const now = new Date();
  const localISO = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
  document.getElementById("inputStartAt").value = localISO;
  document.getElementById("inputNotes").value = "";
  document.getElementById("inputSubject").value = "General";
  showOverlay("stepDuration");
});

/* ---------- Step 1 controls ---------- */
document.getElementById("durCancel").onclick = () => hideOverlay("stepDuration");
document.getElementById("durNext").onclick = () => {
  const h = parseInt(document.getElementById("inputHours").value||0);
  const m = parseInt(document.getElementById("inputMinutes").value||0);
  if (h===0 && m===0){ alert("Set duration (hours or minutes)."); return; }
  state.hours = Math.max(0,h); state.minutes = Math.max(0,m);
  hideOverlay("stepDuration"); showOverlay("stepSchedule");
};

/* ---------- Step 2 controls ---------- */
document.getElementById("schBack").onclick = () => { hideOverlay("stepSchedule"); showOverlay("stepDuration"); };
document.getElementById("schNext").onclick = () => {
  const val = document.getElementById("inputStartAt").value;
  state.startAt = val ? new Date(val) : new Date();
  hideOverlay("stepSchedule"); showOverlay("stepNotes");
};

/* ---------- Step 3 controls (subject handled) ---------- */
document.getElementById("notesBack").onclick = () => { hideOverlay("stepNotes"); showOverlay("stepSchedule"); };
document.getElementById("startSession").onclick = () => {
  state.notes = document.getElementById("inputNotes").value || "";
  state.subject = document.getElementById("inputSubject").value || "General";
  hideOverlay("stepNotes");
  scheduleOrStartSession();
};

/* ================== SCHEDULING & TIMER ================== */
function scheduleOrStartSession() {
  const durationMs = ((state.hours*60) + state.minutes) * 60 * 1000;
  if (!state.startAt) state.startAt = new Date();
  const now = new Date();

  if (state.startAt.getTime() > now.getTime()) {
    const waitMs = state.startAt.getTime() - now.getTime();
    const li = document.createElement("li");
    li.textContent = `${state.startAt.toLocaleString()} ‚Ä¢ ${state.hours}h ${state.minutes}m (${state.subject})`;
    scheduledOverview.appendChild(li);

    state.scheduledTimeoutId = setTimeout(() => {
      if (li.parentNode) li.parentNode.removeChild(li);
      startCountdown(durationMs);
    }, waitMs);

    alert("Session scheduled. It will start at the selected time (tab must be open).");
  } else {
    startCountdown(durationMs);
  }
}

function startCountdown(durationMs) {
  state.countdownRemainingMs = durationMs;
  document.getElementById("timerSessionMeta").textContent = `${state.hours} h ${state.minutes} m ‚Äî ${state.subject} ‚Äî Notes: ${state.notes || "‚Äî"}`;
  showOverlay("timerModal");
  updateTimerDisplay();

  state.timerInterval = setInterval(() => {
    state.countdownRemainingMs -= 1000;
    if (state.countdownRemainingMs <= 0) {
      clearInterval(state.timerInterval);
      state.timerInterval = null;
      hideOverlay("timerModal");
      onTimerEnded();
    } else {
      updateTimerDisplay();
    }
  }, 1000);
}

function updateTimerDisplay(){
  const ms = Math.max(0, state.countdownRemainingMs);
  const totalSec = Math.floor(ms/1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  document.getElementById("timerDisplay").textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

document.getElementById("cancelTimer").onclick = () => {
  if (state.timerInterval) clearInterval(state.timerInterval);
  if (state.scheduledTimeoutId) clearTimeout(state.scheduledTimeoutId);
  state.timerInterval = state.scheduledTimeoutId = null;
  hideOverlay("timerModal");
  alert("Session canceled.");
};

/* ================== WHEN COUNTDOWN ENDS ================== */
function onTimerEnded(){
  if (alarmSound){ alarmSound.currentTime = 0; alarmSound.play().catch(()=>{}); }
  if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission().catch(()=>{});
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification("Session finished", { body: `Session: ${state.hours}h ${state.minutes}m ‚Äî ${state.subject}` });
  }
  document.getElementById("completionMeta").textContent = `Session length: ${state.hours}h ${state.minutes}m ‚Äî ${state.subject} ‚Äî Notes: ${state.notes || "‚Äî"}`;
  showOverlay("completionModal");
}

/* ================== COMPLETION HANDLERS ================== */
document.getElementById("markNo").onclick = () => {
  hideOverlay("completionModal");
  alert("Session discarded (no points awarded).");
};

document.getElementById("markYes").onclick = async () => {
  const durationMinutes = (state.hours * 60) + state.minutes;
  const form = new FormData();
  form.append("subject", state.subject || "General");
  form.append("duration", durationMinutes);
  form.append("notes", state.notes || "");
  form.append("started_at", (state.startAt || new Date()).toISOString());
  form.append("ended_at", new Date().toISOString());

  try {
    const res = await fetch("/add_study_log", { method: "POST", body: form });
    await loadCompletedSessions();
    await loadPoints();
    await loadStudyChart();    // refresh both charts
    hideOverlay("completionModal");
    alert("Session saved and points awarded!");
  } catch (err) {
    console.error(err);
    hideOverlay("completionModal");
    alert("Failed to save session ‚Äî check server logs.");
  }
};

/* ================== LOAD/RENDER DATA ================== */
async function loadCompletedSessions(){
  try {
    const res = await fetch("/get_study_logs");
    const logs = await res.json();
    completedList.innerHTML = "";
    logs.forEach(l => {
      const el = document.createElement("div");
      el.className = "session-item";
      const mins = Number(l.duration || 0);
      const subject = l.subject || "General";
      const created = l.created_at || l.started_at || "";
      el.innerHTML = `
        <div>
          <div style="color:var(--accent)"><strong>${subject}</strong> ‚Äî ${Math.round(mins/60*100)/100}h</div>
          <div class="meta">${l.notes ? l.notes : ""} ‚Ä¢ ${created}</div>
        </div>
        <div style="color:#7df9ff">‚úî</div>`;
      completedList.appendChild(el);
    });
  } catch(e) {
    console.error("Could not load logs", e);
  }
}

async function loadPoints(){
  try {
    const res = await fetch("/get_user_points");
    const data = await res.json();
    pointsEl.textContent = data.points || 0;
  } catch(e){ console.error("Could not load points", e); }
}

/* ================== CHARTS (WEEKLY + SUBJECT PIE) ================== */
async function loadStudyChart(){
  try {
    const res = await fetch("/get_study_logs");
    const logs = await res.json();

    // Weekly totals by weekday (Mon-Sun)
    const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const dayTotals = [0,0,0,0,0,0,0];

    // Subject totals
    const subjectTotals = {}; // {subject: hours}

    logs.forEach(l => {
      const d = new Date(l.created_at || l.started_at || new Date());
      const weekday = d.getDay(); // 0=Sun ... 6=Sat
      const hours = Number(l.duration || 0) / 60;
      const idx = weekday === 0 ? 6 : weekday-1;
      dayTotals[idx] += hours;

      const subj = (l.subject || "General");
      subjectTotals[subj] = (subjectTotals[subj] || 0) + hours;
    });

    // --- Weekly chart (line or bar) ---
    const ctx = document.getElementById("studyChart").getContext("2d");
    if (studyChart) studyChart.destroy();
    studyChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: days,
        datasets: [{
          label: "Hours studied",
          data: dayTotals.map(h => Number(h.toFixed(2))),
          backgroundColor: "rgba(0,208,255,0.55)",
          borderColor: "#00d0ff",
          borderWidth: 1,
          borderRadius: 6
        }]
      },
      options: {
        scales: { y: { beginAtZero: true, ticks: { color: "#9fb2c4" } }, x: { ticks: { color: "#9fb2c4" } } },
        plugins: { legend: { labels: { color: "#9fb2c4" } } }
      }
    });

    // --- Subject distribution pie chart ---
    const subjectLabels = Object.keys(subjectTotals);
    const subjectData = subjectLabels.map(k => Number(subjectTotals[k].toFixed(2)));

    const ctx2 = document.getElementById("subjectChart");
    if (ctx2) {
      const ctx2c = ctx2.getContext("2d");
      if (subjectChart) subjectChart.destroy();
      subjectChart = new Chart(ctx2c, {
        type: "pie",
        data: {
          labels: subjectLabels,
          datasets: [{
            data: subjectData,
            backgroundColor: [
              "#00d0ff","#2ad19f","#ffd24d","#ff6b87","#7d5fff","#00ffa0","#ff9f00"
            ].slice(0, subjectLabels.length),
            borderColor: "#0a1224",
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: "#9fb2c4" } },
            tooltip: {
              callbacks: {
                label: function(ctx){
                  const val = ctx.parsed;
                  return `${ctx.label}: ${val} h`;
                }
              }
            }
          }
        }
      });
    }

  } catch(err) {
    console.error("Could not load chart", err);
  }
}

/* ================== INIT ================== */
(async function init(){
  await loadCompletedSessions();
  await loadPoints();
  await loadStudyChart();
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission().catch(()=>{});
  }
})();
</script>


</body>
</html>
