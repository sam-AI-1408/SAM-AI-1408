<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📈 Market Game</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#050615,#0f1630);
    color: #eaf6ff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    min-height: 100vh;
    margin: 0;
  }
  h1 { margin-bottom: 10px; text-align: center; }
  .stats, .actions, .history, .instructions {
    background: #111b3a;
    padding: 15px 25px;
    border-radius: 15px;
    border: 2px solid #00d0ff;
    margin: 15px 0;
    text-align: center;
    box-shadow: 0 0 15px rgba(0,208,255,0.3);
  }
  .price {
    font-size: 24px;
    font-weight: bold;
    color: #00d0ff;
    transition: color 0.3s ease;
  }
  button {
    margin: 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 12px;
    background: #00d0ff;
    color: #050615;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s ease, filter 0.2s ease;
  }
  button:hover { transform: scale(1.05); filter: brightness(1.1); }
  #message {
    font-size: 18px;
    font-weight: bold;
    margin-top: 10px;
  }
  .win-popup {
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #0f1630;
    border: 2px solid #00d0ff;
    padding: 25px 40px;
    border-radius: 15px;
    font-size: 24px;
    color: #00ff6a;
    display: none;
    text-align: center;
    box-shadow: 0 0 25px rgba(0,255,106,0.5);
    z-index: 1000;
  }
  .history ul { text-align: left; max-height: 150px; overflow-y: auto; padding-left: 20px; }
</style>
</head>
<body>

<h1>📈 Market Game</h1>

<div class="instructions">
  💡 <strong>How to Play:</strong><br>
  You start with 100 coins. Buy items at low prices and sell at high prices. Each turn, the market price changes randomly.<br>
  Make as much profit as possible in 10 turns. Watch for random events that can help or hinder your coins!<br>
  ✅ Aim to end with more coins than you started.
</div>

<div class="stats">
  <p>💰 Coins: <span id="coins" title="Your available money">100</span></p>
  <p>📦 Items: <span id="items" title="Number of items you own">0</span></p>
  <p>Turns Left: <span id="turns">10</span></p>
</div>

<div class="stats">
  <p>Current Item: <span id="itemName">📱 Phone</span></p>
  <p class="price">Price: <span id="price">50</span> coins</p>
</div>

<div class="actions">
  <button onclick="buyItem()">Buy 🛒</button>
  <button onclick="sellItem()">Sell 💰</button>
</div>

<div id="message">⏳ Waiting for market...</div>

<div class="history">
  <h3>📜 Transaction History</h3>
  <ul id="transactionHistory"></ul>
</div>

<button onclick="resetGame()">🔄 New Game</button>
<a href="{{ url_for('quests_page') }}"><button>⬅ Back to Quests</button></a>

<div class="win-popup" id="winPopup"></div>

<!-- Sound effects -->
<audio id="buySound" src="/static/buy.mp3" preload="auto"></audio>
<audio id="sellSound" src="/static/sell.mp3" preload="auto"></audio>
<audio id="eventSound" src="/static/event.mp3" preload="auto"></audio>

<script>
let coins = 100, items = 0, turns = 10, price = 50;
let itemNames = ["📱 Phone", "🎮 Game", "🍎 Apple", "👟 Shoes", "🎧 Headphones"];
let currentItem = "📱 Phone";
let marketInterval;
const transactionHistory = [];

function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function updateDisplay(){
  document.getElementById("coins").textContent = coins;
  document.getElementById("items").textContent = items;
  document.getElementById("turns").textContent = turns;
  document.getElementById("price").textContent = price;
  document.getElementById("itemName").textContent = currentItem;
  // Animate price color
  document.getElementById("price").style.color = randomInt(0,1)? "#00ff6a":"#ff4d6d";
}

function nextTurn(){
  if(turns <= 0){ clearInterval(marketInterval); endGame(); return;}
  turns--;

  // Random price fluctuation
  price = randomInt(20,100);
  currentItem = itemNames[randomInt(0,itemNames.length-1)];
  updateDisplay();

  // Random event
  const eventChance = Math.random();
  if(eventChance < 0.2){
    const bonus = randomInt(5,25);
    coins += bonus;
    document.getElementById("message").textContent = `🎉 Lucky Event! You received ${bonus} coins!`;
    document.getElementById("eventSound").play();
  }else if(eventChance < 0.3 && coins >= 10){
    const loss = randomInt(5,15);
    coins -= loss;
    document.getElementById("message").textContent = `⚠️ Market Crash! Lost ${loss} coins!`;
    document.getElementById("eventSound").play();
  } else {
    document.getElementById("message").textContent = "📊 Market updated!";
  }
}

function buyItem(){
  if(coins >= price){
    coins -= price; items++;
    document.getElementById("buySound").play();
    addTransaction(`Bought 1 ${currentItem} for ${price} coins`);
  }else{
    document.getElementById("message").textContent = "❌ Not enough coins!";
  }
  updateDisplay();
}

function sellItem(){
  if(items>0){
    coins += price; items--;
    document.getElementById("sellSound").play();
    addTransaction(`Sold 1 ${currentItem} for ${price} coins`);
  }else{
    document.getElementById("message").textContent = "❌ You have no items to sell!";
  }
  updateDisplay();
}

function addTransaction(text){
  transactionHistory.push(text);
  const ul = document.getElementById("transactionHistory");
  const li = document.createElement("li");
  li.textContent = text;
  ul.appendChild(li);
}

function endGame(){
  let result = coins>100 ? "🎉 You Win! Great trading!" : "❌ You Lose! Try again!";
  const popup = document.getElementById("winPopup");
  popup.textContent = result + ` Final Coins: ${coins}`;
  popup.style.display = "block";
  clearInterval(marketInterval);
}

function resetGame(){
  coins = 100; items=0; turns=10; price=50; currentItem="📱 Phone";
  transactionHistory.length=0;
  document.getElementById("transactionHistory").innerHTML="";
  updateDisplay();
  document.getElementById("message").textContent = "⏳ Waiting for market...";
  document.getElementById("winPopup").style.display="none";
  clearInterval(marketInterval);
  marketInterval = setInterval(nextTurn,3000);
}

// Start game
resetGame();
</script>

</body>
</html>
